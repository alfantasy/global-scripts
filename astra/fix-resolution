#!/bin/bash

XUSER=$(loginctl list-sessions | awk '$1 ~ /^[0-9]+$/ { print $1 }' | while read session; do
    uid=$(loginctl show-session "$session" -p User --value)
    active=$(loginctl show-session "$session" -p Active --value)
    if [[ "$active" == "yes" ]]; then
        id -nu "$uid"
        break
    fi
done)

export XUSER
export DISPLAY=:0
export XAUTHORITY="/home/$XUSER/.Xauthority"    

generate_xorg_config() {
    echo "Генерация конфигурации Xorg..."
    CONFIG_FILE="/etc/X11/xorg.conf.d/10-fixed-resolution.conf"
    MONITORS=$(xrandr --query | grep " connected" | cut -d" " -f1)

    cat > "$CONFIG_FILE" <<EOF
Section "ServerFlags"
    Option "AutoAddDevices" "false"
    Option "AutoEnableDevices" "false"
EndSection

Section "Device"
    Identifier  "GPU"
    Driver      "modesetting"
    Option      "ModeDebug" "true"
EOF

    echo "Основные флаги установлены."
    if lspci | grep -qi nvidia; then
        echo '    Option "CustomEDID" "none"' >> "$CONFIG_FILE"
        echo '    Option "ModeValidation" "NoEdidModes"' >> "$CONFIG_FILE"
    elif lspci | grep -qi amd; then
        echo '    Option "VariableRefresh" "false"' >> "$CONFIG_FILE"
    fi

    echo 'EndSection' >> "$CONFIG_FILE"

    echo "Заполнение секций мониторов..."
    for MONITOR in $MONITORS; do
        cat >> "$CONFIG_FILE" <<EOF

Section "Monitor"
    Identifier  "$MONITOR"
    Option      "PreferredMode" "1920x1080"
    Option      "IgnoreEDID" "true"
    Option      "UseEDID" "false"
    Option      "DPMS" "false"
    Modeline    "1920x1080_60.00" 173.00 1920 2048 2248 2576 1080 1083 1088 1120 -hsync +vsync
EndSection
EOF
    done

    echo "Заполнение секций экранов..."
    cat >> "$CONFIG_FILE" <<EOF

Section "Screen"
    Identifier  "DefaultScreen"
    Device      "GPU"
    DefaultDepth 24
EOF

    for MONITOR in $MONITORS; do
        echo "    Monitor     \"$MONITOR\"" >> "$CONFIG_FILE"
    done

    cat >> "$CONFIG_FILE" <<EOF
    SubSection "Display"
        Depth    24
        Modes    "1920x1080_60.00"
    EndSubSection
EndSection
EOF
    echo "Конфигурация Xorg сгенерирована."
}

resolution_daemon() {
    echo "Запуск демона мониторинга разрешения..."
    LAST_STATE=$(xrandr --query | grep " connected")

    echo "Найден пользователь с активной сессией: $XUSER"
    echo "Реализация конфигурации под текущего запущенного пользователя с сессией Xorg"

    while true; do
        CURRENT_STATE=$(xrandr --query | grep " connected")
        
        if [ "$CURRENT_STATE" != "$LAST_STATE" ]; then
            echo "Обнаружено изменение конфигурации мониторов! Применяем конфигурацию..."
            generate_xorg_config
            apply_resolution
            LAST_STATE="$CURRENT_STATE"
            echo "Конфигурация применена."
        fi
        
        for MONITOR in $(xrandr --query | grep " connected" | cut -d" " -f1); do
            CURRENT_MODE=$(xrandr --query | grep -A1 "^$MONITOR" | grep -oP '\d+x\d+' | head -1)
            if [ "$CURRENT_MODE" != "1920x1080" ]; then
                echo "Исправляем разрешение для $MONITOR..."
                xrandr --output "$MONITOR" --mode 1920x1080 --rate 60
                echo "Разрешение для $MONITOR установлено в 1920x1080."
            fi
        done
        
        sleep 10
    done
}

apply_resolution() {
    for MONITOR in $(xrandr --query | grep " connected" | cut -d" " -f1); do
        echo "Сервис пытается применить разрешение 1920x1080 для $MONITOR..."
        if ! xrandr | grep -q "1920x1080"; then
            xrandr --newmode "1920x1080_60.00" 173.00 1920 2048 2248 2576 1080 1083 1088 1120 -hsync +vsync
        fi
        xrandr --addmode "$MONITOR" "1920x1080_60.00" 2>/dev/null
        xrandr --output "$MONITOR" --mode "1920x1080_60.00" --rate 60
    done
}

create_systemd_service() {
    echo "Регистрация systemd сервиса..."
    SERVICE_FILE="/etc/systemd/system/resolution-fix.service"

    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Fix display resolution and monitor configuration
After=display-manager.service
Requires=display-manager.service

[Service]
Type=simple
Environment="DISPLAY=$DISPLAY"
Environment="XAUTHORITY=$XAUTHORITY"
User=root
ExecStartPre=/bin/sleep 10
ExecStart=/usr/local/bin/fix-resolution --daemon
Restart=always
RestartSec=5

[Install]
WantedBy=graphical.target
EOF

    echo "Регистрация завершена."
    systemctl daemon-reload
    systemctl enable resolution-fix.service
    systemctl start resolution-fix.service
}

case "$1" in
    --start)
        generate_xorg_config
        apply_resolution
        echo "Конфигурация применена. Для постоянной работы запустите:"
        echo "  $0 --install"
        ;;
    --daemon)
        resolution_daemon
        ;;
    --install)
        generate_xorg_config
        apply_resolution
        create_systemd_service
        echo "Установка Fix Resolution завершена. Сервис resolution-fix.service запущен и добавлен в автозагрузку."
        ;;
    --help)
        echo "Использование fix-resolution:"
        echo "  $0 --start - применение конфигурации без активации демона в системе"
        echo "  $0 --daemon - базовая регистрация демона в системе"
        echo "  $0 --install - полная инсталляция демона в systemd в записью в автозагрузку"
        ;;
    *)
        echo "Неизвестная опция: $1. Используйте fix-resolution --help для вывода справки."
        ;;
esac